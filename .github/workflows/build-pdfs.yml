name: Build PDFs

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:  # Allow manual trigger

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install LaTeX
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            texlive-latex-extra \
            texlive-fonts-extra \
            texlive-fonts-recommended \
            texlive-pictures \
            texlive-latex-recommended \
            texlive-lang-greek \
            latexmk

      - name: Build all PDFs
        run: make parallel

      - name: Collect PDFs
        run: |
          mkdir -p pdf-output
          find . -path './[0-9]*-*/[0-9]*-*/*.pdf' -exec cp {} pdf-output/ \;
          ls -la pdf-output/

      - name: Upload PDFs as artifact
        uses: actions/upload-artifact@v4
        with:
          name: pdf-documents
          path: pdf-output/
          retention-days: 30

  # Deploy to GitHub Pages (only on push to main)
  deploy:
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download PDFs artifact
        uses: actions/download-artifact@v4
        with:
          name: pdf-documents
          path: public/

      - name: Generate index page
        run: |
          # Count total PDFs
          PDF_COUNT=$(ls public/*.pdf 2>/dev/null | wc -l)

          cat > public/index.html << 'HTMLEOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>OT Security Notes - ICS/SCADA Security Learning Resources</title>
            <meta name="description" content="Comprehensive learning documents for ICS/SCADA security professionals covering OT fundamentals, standards, protocols, and incident response.">
            <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üõ°Ô∏è</text></svg>">
            <style>
              :root {
                --primary: #0f172a;
                --accent: #0ea5e9;
                --accent-dark: #0284c7;
                --success: #10b981;
                --warning: #f59e0b;
                --danger: #ef4444;
                --bg: #f8fafc;
                --card-bg: #ffffff;
                --text: #334155;
                --text-muted: #64748b;
                --border: #e2e8f0;
              }

              @media (prefers-color-scheme: dark) {
                :root {
                  --primary: #e2e8f0;
                  --bg: #0f172a;
                  --card-bg: #1e293b;
                  --text: #e2e8f0;
                  --text-muted: #94a3b8;
                  --border: #334155;
                }
              }

              * { box-sizing: border-box; margin: 0; padding: 0; }

              body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
                background: var(--bg);
                color: var(--text);
                line-height: 1.6;
              }

              .hero {
                background: linear-gradient(-45deg, #0f172a, #1e3a5f, #0c4a6e, #164e63);
                background-size: 400% 400%;
                animation: gradientShift 15s ease infinite;
                color: white;
                padding: 3rem 1.5rem;
                text-align: center;
                position: relative;
                overflow: hidden;
              }

              .hero::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-image:
                  radial-gradient(circle at 20% 80%, rgba(14, 165, 233, 0.15) 0%, transparent 50%),
                  radial-gradient(circle at 80% 20%, rgba(16, 185, 129, 0.1) 0%, transparent 50%),
                  radial-gradient(circle at 40% 40%, rgba(139, 92, 246, 0.08) 0%, transparent 40%);
                animation: pulse 8s ease-in-out infinite alternate;
              }

              .hero::after {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
                opacity: 0.5;
              }

              .hero > * {
                position: relative;
                z-index: 1;
              }

              @keyframes gradientShift {
                0% { background-position: 0% 50%; }
                50% { background-position: 100% 50%; }
                100% { background-position: 0% 50%; }
              }

              @keyframes pulse {
                0% { opacity: 0.5; transform: scale(1); }
                100% { opacity: 1; transform: scale(1.1); }
              }

              .hero-icon {
                font-size: 4rem;
                margin-bottom: 1rem;
                animation: float 3s ease-in-out infinite;
              }

              @keyframes float {
                0%, 100% { transform: translateY(0); }
                50% { transform: translateY(-10px); }
              }

              .hero h1 {
                font-size: 2.5rem;
                font-weight: 700;
                margin-bottom: 0.5rem;
              }

              .hero-subtitle {
                font-size: 1.1rem;
                opacity: 0.9;
                max-width: 600px;
                margin: 0 auto 1.5rem;
              }

              .badges {
                display: flex;
                gap: 0.5rem;
                justify-content: center;
                flex-wrap: wrap;
              }

              .badge {
                display: inline-flex;
                align-items: center;
                gap: 0.3rem;
                background: rgba(255,255,255,0.15);
                padding: 0.35rem 0.75rem;
                border-radius: 9999px;
                font-size: 0.8rem;
                backdrop-filter: blur(4px);
              }

              .container {
                max-width: 1000px;
                margin: 0 auto;
                padding: 2rem 1.5rem;
              }

              .search-box {
                margin-bottom: 2rem;
              }

              .search-box input {
                width: 100%;
                padding: 0.875rem 1.25rem;
                font-size: 1rem;
                border: 2px solid var(--border);
                border-radius: 12px;
                background: var(--card-bg);
                color: var(--text);
                transition: border-color 0.2s, box-shadow 0.2s;
              }

              .search-box input:focus {
                outline: none;
                border-color: var(--accent);
                box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
              }

              .search-box input::placeholder {
                color: var(--text-muted);
              }

              .categories {
                display: grid;
                gap: 1.5rem;
              }

              .category {
                background: var(--card-bg);
                border-radius: 16px;
                overflow: hidden;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
                border: 1px solid var(--border);
              }

              .category-header {
                display: flex;
                align-items: center;
                gap: 0.75rem;
                padding: 1rem 1.25rem;
                background: linear-gradient(135deg, var(--card-bg) 0%, var(--bg) 100%);
                border-bottom: 1px solid var(--border);
              }

              .category-icon {
                font-size: 1.5rem;
              }

              .category-title {
                font-size: 1.1rem;
                font-weight: 600;
                color: var(--primary);
              }

              .category-range {
                margin-left: auto;
                font-size: 0.75rem;
                color: var(--text-muted);
                font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
                background: var(--bg);
                padding: 0.25rem 0.5rem;
                border-radius: 6px;
              }

              .doc-list {
                list-style: none;
              }

              .doc-item {
                display: flex;
                align-items: center;
                padding: 0.875rem 1.25rem;
                border-bottom: 1px solid var(--border);
                transition: background 0.15s;
              }

              .doc-item:last-child {
                border-bottom: none;
              }

              .doc-item:hover {
                background: var(--bg);
              }

              .doc-num {
                font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
                font-size: 0.8rem;
                color: var(--accent);
                background: rgba(14, 165, 233, 0.1);
                padding: 0.2rem 0.5rem;
                border-radius: 4px;
                margin-right: 1rem;
                font-weight: 500;
              }

              .doc-link {
                color: var(--text);
                text-decoration: none;
                font-weight: 500;
                flex: 1;
              }

              .doc-link:hover {
                color: var(--accent);
              }

              .doc-pdf {
                font-size: 0.75rem;
                color: var(--text-muted);
                background: var(--bg);
                padding: 0.2rem 0.5rem;
                border-radius: 4px;
              }

              .footer {
                text-align: center;
                padding: 2rem 1.5rem;
                color: var(--text-muted);
                font-size: 0.875rem;
              }

              .footer a {
                color: var(--accent);
                text-decoration: none;
              }

              .footer a:hover {
                text-decoration: underline;
              }

              .footer-links {
                display: flex;
                justify-content: center;
                gap: 1.5rem;
                margin-bottom: 1rem;
              }

              .hidden {
                display: none !important;
              }

              .no-results {
                text-align: center;
                padding: 3rem;
                color: var(--text-muted);
              }

              @media (max-width: 640px) {
                .hero h1 { font-size: 1.75rem; }
                .hero-subtitle { font-size: 1rem; }
                .doc-item { flex-wrap: wrap; gap: 0.5rem; }
                .doc-pdf { display: none; }
              }
            </style>
          </head>
          <body>
            <header class="hero">
              <div class="hero-icon">üõ°Ô∏è</div>
              <h1>OT Security Notes</h1>
              <p class="hero-subtitle">
                Comprehensive learning documents for ICS/SCADA security professionals.
                Vendor-neutral, standards-based, and focused on practical knowledge.
              </p>
              <div class="badges">
                <span class="badge">üìÑ PDF_COUNT Documents</span>
                <span class="badge">üìñ Under 10 pages each</span>
                <span class="badge">‚öñÔ∏è CC BY-SA 4.0</span>
              </div>
            </header>

            <main class="container">
              <div class="search-box">
                <input type="text" id="search" placeholder="Search documents..." autocomplete="off">
              </div>

              <div class="categories" id="categories">
          HTMLEOF

          # Define categories with icons
          declare -A CATEGORIES
          declare -A ICONS
          CATEGORIES["001-099"]="Fundamentals"
          CATEGORIES["100-199"]="Standards & Compliance"
          CATEGORIES["200-299"]="Protocols & Technologies"
          CATEGORIES["300-399"]="Architecture & Design"
          CATEGORIES["400-499"]="Threats & Attacks"
          CATEGORIES["500-599"]="Detection & Monitoring"
          CATEGORIES["600-699"]="Incident Response"
          CATEGORIES["700-799"]="Assessments"
          CATEGORIES["800-899"]="Solutions & Tools"

          ICONS["001-099"]="üí°"
          ICONS["100-199"]="üìú"
          ICONS["200-299"]="üîå"
          ICONS["300-399"]="üèóÔ∏è"
          ICONS["400-499"]="üíÄ"
          ICONS["500-599"]="üîç"
          ICONS["600-699"]="üö®"
          ICONS["700-799"]="üìã"
          ICONS["800-899"]="üîß"

          # Process each category
          for range in "001-099" "100-199" "200-299" "300-399" "400-499" "500-599" "600-699" "700-799" "800-899"; do
            start=${range%-*}
            end=${range#*-}
            category_name="${CATEGORIES[$range]}"
            category_icon="${ICONS[$range]}"

            # Find PDFs in this range
            pdfs=$(ls public/*.pdf 2>/dev/null | xargs -I {} basename {} .pdf | grep -E "^[0-9]{3}-" | while read name; do
              num=${name%%-*}
              if [ "$num" -ge "$start" ] && [ "$num" -le "$end" ]; then
                echo "$name"
              fi
            done | sort)

            if [ -n "$pdfs" ]; then
              echo "            <div class=\"category\" data-category=\"$category_name\">" >> public/index.html
              echo "              <div class=\"category-header\">" >> public/index.html
              echo "                <span class=\"category-icon\">$category_icon</span>" >> public/index.html
              echo "                <span class=\"category-title\">$category_name</span>" >> public/index.html
              echo "                <span class=\"category-range\">$range</span>" >> public/index.html
              echo "              </div>" >> public/index.html
              echo "              <ul class=\"doc-list\">" >> public/index.html

              echo "$pdfs" | while read pdf_name; do
                doc_num=${pdf_name%%-*}
                title=$(echo "${pdf_name#*-}" | sed 's/-/ /g' | sed 's/\b\(.\)/\u\1/g')
                echo "                <li class=\"doc-item\" data-title=\"$title\">" >> public/index.html
                echo "                  <span class=\"doc-num\">$doc_num</span>" >> public/index.html
                echo "                  <a href=\"${pdf_name}.pdf\" class=\"doc-link\">$title</a>" >> public/index.html
                echo "                  <span class=\"doc-pdf\">PDF</span>" >> public/index.html
                echo "                </li>" >> public/index.html
              done

              echo "              </ul>" >> public/index.html
              echo "            </div>" >> public/index.html
            fi
          done

          cat >> public/index.html << 'HTMLEOF'
              </div>
              <div class="no-results hidden" id="no-results">
                No documents found matching your search.
              </div>
            </main>

            <footer class="footer">
              <div class="footer-links">
                <a href="https://github.com/mniedermaier/OTsecNotes">üì¶ GitHub Repository</a>
                <a href="https://github.com/mniedermaier/OTsecNotes/issues/new?template=new-document-request.yml">üìù Request Document</a>
                <a href="https://github.com/mniedermaier/OTsecNotes/issues">üêõ Report Issue</a>
              </div>
              <p>Last updated: TIMESTAMP</p>
              <p style="margin-top: 0.5rem;">ü§ñ Created with AI assistance ¬∑ Licensed under CC BY-SA 4.0</p>
            </footer>

            <script>
              const search = document.getElementById('search');
              const categories = document.querySelectorAll('.category');
              const noResults = document.getElementById('no-results');

              search.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase().trim();
                let hasResults = false;

                categories.forEach(cat => {
                  const items = cat.querySelectorAll('.doc-item');
                  let categoryHasMatch = false;

                  items.forEach(item => {
                    const title = item.dataset.title.toLowerCase();
                    const num = item.querySelector('.doc-num').textContent;
                    const matches = title.includes(query) || num.includes(query);
                    item.classList.toggle('hidden', !matches && query !== '');
                    if (matches || query === '') categoryHasMatch = true;
                  });

                  cat.classList.toggle('hidden', !categoryHasMatch);
                  if (categoryHasMatch) hasResults = true;
                });

                noResults.classList.toggle('hidden', hasResults || query === '');
              });
            </script>
          </body>
          </html>
          HTMLEOF

          # Replace placeholders
          sed -i "s/TIMESTAMP/$(date -u +'%Y-%m-%d %H:%M UTC')/g" public/index.html
          sed -i "s/PDF_COUNT/$PDF_COUNT/g" public/index.html

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload to Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: public/

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
