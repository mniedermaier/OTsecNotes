name: Build PDFs

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:  # Allow manual trigger

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install LaTeX
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            texlive-latex-extra \
            texlive-fonts-extra \
            texlive-fonts-recommended \
            texlive-pictures \
            texlive-latex-recommended \
            texlive-lang-greek \
            latexmk

      - name: Build all PDFs
        run: make parallel

      - name: Collect PDFs
        run: |
          mkdir -p pdf-output
          find . -path './[0-9]*-*/[0-9]*-*/*.pdf' -exec cp {} pdf-output/ \;
          ls -la pdf-output/

      - name: Upload PDFs as artifact
        uses: actions/upload-artifact@v4
        with:
          name: pdf-documents
          path: pdf-output/
          retention-days: 30

  # Deploy to GitHub Pages (only on push to main)
  deploy:
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download PDFs artifact
        uses: actions/download-artifact@v4
        with:
          name: pdf-documents
          path: public/

      - name: Generate index page
        run: |
          PDF_COUNT=$(ls public/*.pdf 2>/dev/null | wc -l)

          cat > public/index.html << 'HTMLEOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>OT Security Notes - ICS/SCADA Security Learning Resources</title>
            <meta name="description" content="Comprehensive learning documents for ICS/SCADA security professionals covering OT fundamentals, standards, protocols, and incident response.">
            <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üõ°Ô∏è</text></svg>">
            <style>
              :root {
                --primary: #0f172a;
                --accent: #0ea5e9;
                --bg: #0f172a;
                --card-bg: rgba(30, 41, 59, 0.85);
                --text: #e2e8f0;
                --text-muted: #94a3b8;
                --border: rgba(71, 85, 105, 0.5);
              }
              * { box-sizing: border-box; margin: 0; padding: 0; }
              body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
                color: var(--text);
                line-height: 1.6;
                min-height: 100vh;
              }
              #particles-canvas {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: 0;
                pointer-events: none;
              }
              .glow-orb {
                position: fixed;
                border-radius: 50%;
                filter: blur(100px);
                opacity: 0.4;
                z-index: 0;
                pointer-events: none;
              }
              .glow-orb-1 {
                width: 500px;
                height: 500px;
                background: radial-gradient(circle, #0ea5e9 0%, transparent 70%);
                top: -150px;
                left: -150px;
                animation: orbFloat1 25s ease-in-out infinite;
              }
              .glow-orb-2 {
                width: 400px;
                height: 400px;
                background: radial-gradient(circle, #8b5cf6 0%, transparent 70%);
                bottom: -100px;
                right: -100px;
                animation: orbFloat2 30s ease-in-out infinite;
              }
              .glow-orb-3 {
                width: 350px;
                height: 350px;
                background: radial-gradient(circle, #10b981 0%, transparent 70%);
                top: 40%;
                right: 20%;
                animation: orbFloat3 20s ease-in-out infinite;
              }
              .glow-orb-4 {
                width: 300px;
                height: 300px;
                background: radial-gradient(circle, #f59e0b 0%, transparent 70%);
                bottom: 30%;
                left: 10%;
                animation: orbFloat4 22s ease-in-out infinite;
              }
              @keyframes orbFloat1 {
                0%, 100% { transform: translate(0, 0) scale(1); }
                33% { transform: translate(100px, 50px) scale(1.2); }
                66% { transform: translate(50px, 100px) scale(0.9); }
              }
              @keyframes orbFloat2 {
                0%, 100% { transform: translate(0, 0) scale(1); }
                33% { transform: translate(-80px, -40px) scale(1.1); }
                66% { transform: translate(-40px, -80px) scale(0.95); }
              }
              @keyframes orbFloat3 {
                0%, 100% { transform: translate(0, 0) scale(1); }
                50% { transform: translate(-60px, 60px) scale(1.15); }
              }
              @keyframes orbFloat4 {
                0%, 100% { transform: translate(0, 0) scale(1); }
                50% { transform: translate(70px, -50px) scale(1.1); }
              }
              .hero {
                position: relative;
                z-index: 1;
                color: white;
                padding: 5rem 1.5rem;
                text-align: center;
                min-height: 450px;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
              }
              .hero-icon {
                font-size: 5rem;
                margin-bottom: 1.5rem;
                animation: pulse-glow 2s ease-in-out infinite;
                filter: drop-shadow(0 0 40px rgba(14, 165, 233, 0.6));
              }
              @keyframes pulse-glow {
                0%, 100% { transform: scale(1); filter: drop-shadow(0 0 40px rgba(14, 165, 233, 0.6)); }
                50% { transform: scale(1.1); filter: drop-shadow(0 0 60px rgba(14, 165, 233, 0.9)); }
              }
              .hero h1 {
                font-size: 3.5rem;
                font-weight: 800;
                margin-bottom: 1rem;
                background: linear-gradient(135deg, #ffffff 0%, #0ea5e9 40%, #8b5cf6 60%, #ffffff 100%);
                background-size: 300% auto;
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
                animation: shine 4s linear infinite;
              }
              @keyframes shine {
                to { background-position: 300% center; }
              }
              .hero-subtitle {
                font-size: 1.25rem;
                opacity: 0.9;
                max-width: 650px;
                margin: 0 auto 2rem;
                line-height: 1.8;
              }
              .badges {
                display: flex;
                gap: 1rem;
                justify-content: center;
                flex-wrap: wrap;
              }
              .badge {
                display: inline-flex;
                align-items: center;
                gap: 0.5rem;
                background: rgba(255,255,255,0.08);
                border: 1px solid rgba(255,255,255,0.15);
                padding: 0.6rem 1.2rem;
                border-radius: 9999px;
                font-size: 0.95rem;
                backdrop-filter: blur(20px);
                transition: all 0.3s ease;
              }
              .badge:hover {
                background: rgba(255,255,255,0.15);
                transform: translateY(-3px);
                box-shadow: 0 15px 40px rgba(0,0,0,0.4);
              }
              .container {
                position: relative;
                z-index: 1;
                max-width: 1000px;
                margin: 0 auto;
                padding: 2rem 1.5rem 4rem;
              }
              .search-box { margin-bottom: 2.5rem; }
              .search-box input {
                width: 100%;
                padding: 1.1rem 1.5rem;
                font-size: 1.05rem;
                border: 1px solid var(--border);
                border-radius: 16px;
                background: rgba(30, 41, 59, 0.7);
                color: var(--text);
                transition: all 0.3s ease;
                box-shadow: 0 4px 20px rgba(0,0,0,0.2);
                backdrop-filter: blur(20px);
              }
              .search-box input:focus {
                outline: none;
                border-color: var(--accent);
                box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.2), 0 15px 50px rgba(0,0,0,0.3);
                transform: translateY(-2px);
                background: rgba(30, 41, 59, 0.9);
              }
              .search-box input::placeholder { color: var(--text-muted); }
              .categories { display: grid; gap: 1.75rem; }
              .category {
                background: var(--card-bg);
                border-radius: 20px;
                overflow: hidden;
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                border: 1px solid var(--border);
                transition: all 0.3s ease;
                backdrop-filter: blur(20px);
              }
              .category:hover {
                transform: translateY(-6px);
                box-shadow: 0 25px 60px rgba(0,0,0,0.4);
                border-color: rgba(14, 165, 233, 0.3);
              }
              .category-header {
                display: flex;
                align-items: center;
                gap: 1rem;
                padding: 1.25rem 1.5rem;
                background: linear-gradient(135deg, rgba(30, 41, 59, 0.5) 0%, rgba(15, 23, 42, 0.5) 100%);
                border-bottom: 1px solid var(--border);
              }
              .category-icon {
                font-size: 1.75rem;
                width: 55px;
                height: 55px;
                display: flex;
                align-items: center;
                justify-content: center;
                background: linear-gradient(135deg, rgba(14, 165, 233, 0.2) 0%, rgba(139, 92, 246, 0.2) 100%);
                border-radius: 14px;
                border: 1px solid rgba(255,255,255,0.1);
              }
              .category-title { font-size: 1.2rem; font-weight: 600; color: var(--text); }
              .category-range {
                margin-left: auto;
                font-size: 0.8rem;
                color: var(--text-muted);
                font-family: monospace;
                background: rgba(0,0,0,0.3);
                padding: 0.4rem 0.8rem;
                border-radius: 8px;
                border: 1px solid var(--border);
              }
              .doc-list { list-style: none; }
              .doc-item {
                display: flex;
                align-items: center;
                padding: 1rem 1.5rem;
                border-bottom: 1px solid var(--border);
                transition: all 0.25s ease;
              }
              .doc-item:last-child { border-bottom: none; }
              .doc-item:hover {
                background: linear-gradient(135deg, rgba(14, 165, 233, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
                padding-left: 2rem;
              }
              .doc-num {
                font-family: monospace;
                font-size: 0.85rem;
                color: white;
                background: linear-gradient(135deg, #0ea5e9 0%, #8b5cf6 100%);
                padding: 0.35rem 0.75rem;
                border-radius: 8px;
                margin-right: 1rem;
                font-weight: 600;
                box-shadow: 0 2px 10px rgba(14, 165, 233, 0.3);
              }
              .doc-link {
                color: var(--text);
                text-decoration: none;
                font-weight: 500;
                flex: 1;
                transition: all 0.2s;
              }
              .doc-link:hover { color: var(--accent); }
              .doc-pdf {
                font-size: 0.7rem;
                color: white;
                background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                padding: 0.3rem 0.7rem;
                border-radius: 6px;
                font-weight: 700;
                text-transform: uppercase;
              }
              .footer {
                position: relative;
                z-index: 1;
                text-align: center;
                padding: 4rem 1.5rem;
                color: var(--text-muted);
                font-size: 0.95rem;
              }
              .footer a { color: var(--accent); text-decoration: none; font-weight: 500; }
              .footer a:hover { text-decoration: underline; }
              .footer-links { display: flex; justify-content: center; gap: 2.5rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
              .hidden { display: none !important; }
              .no-results { text-align: center; padding: 3rem; color: var(--text-muted); }
              @media (max-width: 640px) {
                .hero h1 { font-size: 2.2rem; }
                .hero-icon { font-size: 3.5rem; }
                .doc-item { flex-wrap: wrap; gap: 0.5rem; }
                .doc-pdf { display: none; }
                .footer-links { gap: 1.5rem; }
              }
            </style>
          </head>
          <body>
            <div class="glow-orb glow-orb-1"></div>
            <div class="glow-orb glow-orb-2"></div>
            <div class="glow-orb glow-orb-3"></div>
            <div class="glow-orb glow-orb-4"></div>
            <canvas id="particles-canvas"></canvas>
            <header class="hero">
              <div class="hero-icon">üõ°Ô∏è</div>
              <h1>OT Security Notes</h1>
              <p class="hero-subtitle">
                Comprehensive learning documents for ICS/SCADA security professionals.
                Vendor-neutral, standards-based, and focused on practical knowledge.
              </p>
              <div class="badges">
                <span class="badge">üìÑ PDF_COUNT Documents</span>
                <span class="badge">üìñ Under 10 pages each</span>
                <span class="badge">‚öñÔ∏è CC BY-SA 4.0</span>
              </div>
            </header>
            <main class="container">
              <div class="search-box">
                <input type="text" id="search" placeholder="üîç Search documents..." autocomplete="off">
              </div>
              <div class="categories" id="categories">
          HTMLEOF

          # Define categories with icons
          declare -A CATEGORIES
          declare -A ICONS
          CATEGORIES["001-099"]="Fundamentals"
          CATEGORIES["100-199"]="Standards & Compliance"
          CATEGORIES["200-299"]="Protocols & Technologies"
          CATEGORIES["300-399"]="Architecture & Design"
          CATEGORIES["400-499"]="Threats & Attacks"
          CATEGORIES["500-599"]="Detection & Monitoring"
          CATEGORIES["600-699"]="Incident Response"
          CATEGORIES["700-799"]="Assessments"
          CATEGORIES["800-899"]="Solutions & Tools"

          ICONS["001-099"]="üí°"
          ICONS["100-199"]="üìú"
          ICONS["200-299"]="üîå"
          ICONS["300-399"]="üèóÔ∏è"
          ICONS["400-499"]="üíÄ"
          ICONS["500-599"]="üîç"
          ICONS["600-699"]="üö®"
          ICONS["700-799"]="üìã"
          ICONS["800-899"]="üîß"

          for range in "001-099" "100-199" "200-299" "300-399" "400-499" "500-599" "600-699" "700-799" "800-899"; do
            start=${range%-*}
            end=${range#*-}
            category_name="${CATEGORIES[$range]}"
            category_icon="${ICONS[$range]}"

            pdfs=$(ls public/*.pdf 2>/dev/null | xargs -I {} basename {} .pdf | grep -E "^[0-9]{3}-" | while read name; do
              num=${name%%-*}
              if [ "$num" -ge "$start" ] && [ "$num" -le "$end" ]; then
                echo "$name"
              fi
            done | sort)

            if [ -n "$pdfs" ]; then
              echo "            <div class=\"category\" data-category=\"$category_name\">" >> public/index.html
              echo "              <div class=\"category-header\">" >> public/index.html
              echo "                <span class=\"category-icon\">$category_icon</span>" >> public/index.html
              echo "                <span class=\"category-title\">$category_name</span>" >> public/index.html
              echo "                <span class=\"category-range\">$range</span>" >> public/index.html
              echo "              </div>" >> public/index.html
              echo "              <ul class=\"doc-list\">" >> public/index.html

              echo "$pdfs" | while read pdf_name; do
                doc_num=${pdf_name%%-*}
                title=$(echo "${pdf_name#*-}" | sed 's/-/ /g' | sed 's/\b\(.\)/\u\1/g')
                echo "                <li class=\"doc-item\" data-title=\"$title\">" >> public/index.html
                echo "                  <span class=\"doc-num\">$doc_num</span>" >> public/index.html
                echo "                  <a href=\"${pdf_name}.pdf\" class=\"doc-link\">$title</a>" >> public/index.html
                echo "                  <span class=\"doc-pdf\">PDF</span>" >> public/index.html
                echo "                </li>" >> public/index.html
              done

              echo "              </ul>" >> public/index.html
              echo "            </div>" >> public/index.html
            fi
          done

          cat >> public/index.html << 'HTMLEOF'
              </div>
              <div class="no-results hidden" id="no-results">No documents found matching your search.</div>
            </main>
            <footer class="footer">
              <div class="footer-links">
                <a href="https://github.com/mniedermaier/OTsecNotes">üì¶ GitHub Repository</a>
                <a href="https://github.com/mniedermaier/OTsecNotes/issues/new?template=new-document-request.yml">üìù Request Document</a>
                <a href="https://github.com/mniedermaier/OTsecNotes/issues">üêõ Report Issue</a>
              </div>
              <p>Last updated: TIMESTAMP</p>
              <p style="margin-top: 0.5rem;">ü§ñ Created with AI assistance ¬∑ Licensed under CC BY-SA 4.0</p>
            </footer>
            <script>
              const canvas = document.getElementById('particles-canvas');
              const ctx = canvas.getContext('2d');
              let particles = [];
              let mouse = { x: null, y: null, radius: 180 };

              function resizeCanvas() {
                canvas.width = window.innerWidth;
                canvas.height = document.documentElement.scrollHeight;
              }
              resizeCanvas();
              window.addEventListener('resize', () => { resizeCanvas(); initParticles(); });

              let lastHeight = 0;
              setInterval(() => {
                const newHeight = document.documentElement.scrollHeight;
                if (newHeight !== lastHeight) { canvas.height = newHeight; lastHeight = newHeight; }
              }, 1000);

              document.addEventListener('mousemove', (e) => {
                mouse.x = e.clientX;
                mouse.y = e.clientY + window.scrollY;
              });
              document.addEventListener('mouseleave', () => { mouse.x = null; mouse.y = null; });

              class Particle {
                constructor() {
                  this.x = Math.random() * canvas.width;
                  this.y = Math.random() * canvas.height;
                  this.size = Math.random() * 2.5 + 0.5;
                  this.speedX = (Math.random() - 0.5) * 0.8;
                  this.speedY = (Math.random() - 0.5) * 0.8;
                  this.opacity = Math.random() * 0.5 + 0.2;
                  const hue = 190 + Math.random() * 50;
                  this.color = 'hsla(' + hue + ', 80%, 65%, ' + this.opacity + ')';
                }
                draw() {
                  ctx.fillStyle = this.color;
                  ctx.beginPath();
                  ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                  ctx.fill();
                }
                update() {
                  if (mouse.x != null && mouse.y != null) {
                    let dx = mouse.x - this.x;
                    let dy = mouse.y - this.y;
                    let distance = Math.sqrt(dx * dx + dy * dy);
                    if (distance < mouse.radius) {
                      let force = (mouse.radius - distance) / mouse.radius;
                      this.x -= (dx / distance) * force * 3;
                      this.y -= (dy / distance) * force * 3;
                    }
                  }
                  this.x += this.speedX;
                  this.y += this.speedY;
                  if (this.x < 0) this.x = canvas.width;
                  if (this.x > canvas.width) this.x = 0;
                  if (this.y < 0) this.y = canvas.height;
                  if (this.y > canvas.height) this.y = 0;
                }
              }

              function initParticles() {
                particles = [];
                const num = Math.min((canvas.width * canvas.height) / 8000, 300);
                for (let i = 0; i < num; i++) particles.push(new Particle());
              }
              initParticles();

              function connectParticles() {
                for (let a = 0; a < particles.length; a++) {
                  for (let b = a + 1; b < particles.length; b++) {
                    let dx = particles[a].x - particles[b].x;
                    let dy = particles[a].y - particles[b].y;
                    let distance = Math.sqrt(dx * dx + dy * dy);
                    if (distance < 150) {
                      ctx.strokeStyle = 'rgba(14, 165, 233, ' + ((1 - distance / 150) * 0.15) + ')';
                      ctx.lineWidth = 1;
                      ctx.beginPath();
                      ctx.moveTo(particles[a].x, particles[a].y);
                      ctx.lineTo(particles[b].x, particles[b].y);
                      ctx.stroke();
                    }
                  }
                }
              }

              function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                particles.forEach(p => { p.update(); p.draw(); });
                connectParticles();
                requestAnimationFrame(animate);
              }
              animate();

              const search = document.getElementById('search');
              const categories = document.querySelectorAll('.category');
              const noResults = document.getElementById('no-results');
              search.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase().trim();
                let hasResults = false;
                categories.forEach(cat => {
                  const items = cat.querySelectorAll('.doc-item');
                  let match = false;
                  items.forEach(item => {
                    const title = item.dataset.title.toLowerCase();
                    const num = item.querySelector('.doc-num').textContent;
                    const m = title.includes(query) || num.includes(query);
                    item.classList.toggle('hidden', !m && query !== '');
                    if (m || query === '') match = true;
                  });
                  cat.classList.toggle('hidden', !match);
                  if (match) hasResults = true;
                });
                noResults.classList.toggle('hidden', hasResults || query === '');
              });
            </script>
          </body>
          </html>
          HTMLEOF

          sed -i "s/TIMESTAMP/$(date -u +'%Y-%m-%d %H:%M UTC')/g" public/index.html
          sed -i "s/PDF_COUNT/$PDF_COUNT/g" public/index.html

      - name: Setup Pages
        uses: actions/configure-pages@v4
        with:
          enablement: true

      - name: Upload to Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: public/

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
