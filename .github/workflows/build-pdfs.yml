name: Build PDFs

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:  # Allow manual trigger

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install LaTeX
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            texlive-latex-extra \
            texlive-fonts-extra \
            texlive-fonts-recommended \
            texlive-pictures \
            texlive-latex-recommended \
            texlive-lang-greek \
            latexmk \
            poppler-utils

      - name: Build all PDFs
        run: make parallel

      - name: Collect PDFs and generate thumbnails
        run: |
          mkdir -p pdf-output
          mkdir -p pdf-output/thumbnails
          find . -path './[0-9]*-*/[0-9]*-*/*.pdf' -exec cp {} pdf-output/ \;

          # Generate thumbnails for each PDF (first page only)
          for pdf in pdf-output/*.pdf; do
            filename=$(basename "$pdf" .pdf)
            pdftoppm -png -f 1 -l 1 -scale-to 400 "$pdf" "pdf-output/thumbnails/${filename}"
            # pdftoppm adds -1 or -01 suffix depending on version, rename it
            mv "pdf-output/thumbnails/${filename}-1.png" "pdf-output/thumbnails/${filename}.png" 2>/dev/null || \
            mv "pdf-output/thumbnails/${filename}-01.png" "pdf-output/thumbnails/${filename}.png" 2>/dev/null || true
          done

          # Generate search index from PDF text content
          chmod +x scripts/generate-search-index.sh
          ./scripts/generate-search-index.sh pdf-output pdf-output/search-index.json

          # Create ZIP of all PDFs for "Download All" button
          cd pdf-output
          zip -r OTsecNotes-all-documents.zip *.pdf
          cd ..

          echo "PDFs:"
          ls -la pdf-output/*.pdf
          echo "Thumbnails:"
          ls -la pdf-output/thumbnails/
          echo "Search index:"
          ls -la pdf-output/search-index.json
          echo "ZIP:"
          ls -la pdf-output/*.zip

      - name: Check page count (max 10 pages)
        run: |
          MAX_PAGES=10
          FAILED=0
          echo "üìÑ Checking document page counts (max: $MAX_PAGES pages)"
          echo "================================================"
          for pdf in pdf-output/*.pdf; do
            filename=$(basename "$pdf")
            pages=$(pdfinfo "$pdf" | grep "^Pages:" | awk '{print $2}')
            if [ "$pages" -gt "$MAX_PAGES" ]; then
              echo "‚ùå FAIL: $filename has $pages pages (exceeds $MAX_PAGES)"
              FAILED=1
            else
              echo "‚úÖ OK: $filename ($pages pages)"
            fi
          done
          echo "================================================"
          if [ "$FAILED" -eq 1 ]; then
            echo "::error::One or more documents exceed the $MAX_PAGES page limit. Please reduce content."
            exit 1
          fi
          echo "‚úÖ All documents are within the $MAX_PAGES page limit."

      - name: Upload PDFs as artifact
        uses: actions/upload-artifact@v4
        with:
          name: pdf-documents
          path: pdf-output/
          retention-days: 30

  # Deploy to GitHub Pages (only on push to main)
  deploy:
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download PDFs artifact
        uses: actions/download-artifact@v4
        with:
          name: pdf-documents
          path: public/

      - name: Copy viewer page
        run: |
          cp pages/viewer.html public/viewer.html

      - name: Generate index page
        run: |
          PDF_COUNT=$(ls public/*.pdf 2>/dev/null | wc -l)

          cat > public/index.html << 'HTMLEOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>OT Security Notes - ICS/SCADA Security Learning Resources</title>
            <meta name="description" content="Comprehensive learning documents for ICS/SCADA security professionals covering OT fundamentals, standards, protocols, and incident response.">
            <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üõ°Ô∏è</text></svg>">
            <link rel="preconnect" href="https://fonts.googleapis.com">
            <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
            <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
            <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0/dist/fuse.min.js"></script>
            <style>
              :root {
                --primary: #0f172a;
                --primary-light: #1e293b;
                --accent: #0ea5e9;
                --accent-purple: #8b5cf6;
                --success: #10b981;
                --warning: #f59e0b;
                --danger: #ef4444;
                --text: #f1f5f9;
                --text-secondary: #cbd5e1;
                --text-muted: #64748b;
                --border: rgba(148, 163, 184, 0.1);
                --card-bg: rgba(30, 41, 59, 0.6);
                --glass: rgba(15, 23, 42, 0.8);
                --radius: 16px;
                --radius-sm: 10px;
                --shadow: 0 4px 24px rgba(0, 0, 0, 0.25);
                --shadow-lg: 0 12px 48px rgba(0, 0, 0, 0.35);
              }

              * { box-sizing: border-box; margin: 0; padding: 0; }

              html { scroll-behavior: smooth; }

              body {
                font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
                background: var(--primary);
                color: var(--text);
                line-height: 1.6;
                min-height: 100vh;
                -webkit-font-smoothing: antialiased;
              }

              /* Subtle background gradient */
              .bg-gradient {
                position: fixed;
                inset: 0;
                background:
                  radial-gradient(ellipse 80% 50% at 50% -20%, rgba(14, 165, 233, 0.15), transparent),
                  radial-gradient(ellipse 60% 40% at 100% 100%, rgba(139, 92, 246, 0.1), transparent),
                  var(--primary);
                z-index: -1;
              }

              /* Header */
              .header {
                position: sticky;
                top: 0;
                z-index: 100;
                background: var(--glass);
                backdrop-filter: blur(20px);
                -webkit-backdrop-filter: blur(20px);
                border-bottom: 1px solid var(--border);
              }

              .header-inner {
                max-width: 1200px;
                margin: 0 auto;
                padding: 0.75rem 1.5rem;
                display: flex;
                align-items: center;
                gap: 1rem;
              }

              .logo {
                display: flex;
                align-items: center;
                gap: 0.75rem;
                text-decoration: none;
                color: var(--text);
                font-weight: 700;
                font-size: 1.1rem;
                white-space: nowrap;
              }

              .logo-icon {
                font-size: 1.5rem;
              }

              .logo span { display: none; }
              @media (min-width: 640px) { .logo span { display: inline; } }

              /* Search */
              .search-container {
                flex: 1;
                max-width: 500px;
                position: relative;
              }

              .search-input {
                width: 100%;
                padding: 0.65rem 1rem 0.65rem 2.5rem;
                font-size: 0.9rem;
                font-family: inherit;
                border: 1px solid var(--border);
                border-radius: var(--radius-sm);
                background: rgba(255, 255, 255, 0.05);
                color: var(--text);
                transition: all 0.2s ease;
              }

              .search-input:focus {
                outline: none;
                border-color: var(--accent);
                background: rgba(255, 255, 255, 0.08);
                box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.15);
              }

              .search-input::placeholder { color: var(--text-muted); }

              .search-icon {
                position: absolute;
                left: 0.85rem;
                top: 50%;
                transform: translateY(-50%);
                color: var(--text-muted);
                font-size: 0.85rem;
                pointer-events: none;
              }

              .header-actions {
                display: flex;
                gap: 0.5rem;
                align-items: center;
              }

              .btn {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                gap: 0.4rem;
                padding: 0.5rem 1rem;
                font-size: 0.85rem;
                font-weight: 500;
                font-family: inherit;
                border: 1px solid var(--border);
                border-radius: var(--radius-sm);
                background: rgba(255, 255, 255, 0.05);
                color: var(--text-secondary);
                cursor: pointer;
                transition: all 0.2s ease;
                text-decoration: none;
                white-space: nowrap;
              }

              .btn:hover {
                background: rgba(255, 255, 255, 0.1);
                border-color: rgba(255, 255, 255, 0.2);
                color: var(--text);
              }

              .btn-primary {
                background: var(--success);
                border-color: var(--success);
                color: white;
              }

              .btn-primary:hover {
                background: #059669;
                border-color: #059669;
                color: white;
              }

              .btn-icon { font-size: 1rem; }

              /* Hero */
              .hero {
                text-align: center;
                padding: 4rem 1.5rem 3rem;
                max-width: 800px;
                margin: 0 auto;
              }

              .hero-badge {
                display: inline-flex;
                align-items: center;
                gap: 0.5rem;
                padding: 0.4rem 1rem;
                font-size: 0.8rem;
                font-weight: 500;
                background: rgba(14, 165, 233, 0.15);
                border: 1px solid rgba(14, 165, 233, 0.3);
                border-radius: 50px;
                color: var(--accent);
                margin-bottom: 1.5rem;
              }

              .hero h1 {
                font-size: clamp(2rem, 5vw, 3rem);
                font-weight: 700;
                letter-spacing: -0.02em;
                margin-bottom: 1rem;
                background: linear-gradient(135deg, var(--text) 0%, var(--accent) 50%, var(--accent-purple) 100%);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
              }

              .hero p {
                font-size: 1.1rem;
                color: var(--text-secondary);
                max-width: 600px;
                margin: 0 auto 2rem;
              }

              .hero-stats {
                display: flex;
                justify-content: center;
                gap: 2rem;
                flex-wrap: wrap;
              }

              .stat {
                text-align: center;
              }

              .stat-value {
                font-size: 1.75rem;
                font-weight: 700;
                color: var(--text);
              }

              .stat-label {
                font-size: 0.8rem;
                color: var(--text-muted);
                text-transform: uppercase;
                letter-spacing: 0.05em;
              }

              /* Main content */
              .main {
                max-width: 1200px;
                margin: 0 auto;
                padding: 0 1.5rem 4rem;
              }

              /* Search mode tabs */
              .search-tabs {
                display: flex;
                gap: 0.25rem;
                padding: 0.25rem;
                background: rgba(255, 255, 255, 0.03);
                border-radius: var(--radius-sm);
                margin-bottom: 1.5rem;
                width: fit-content;
              }

              .search-tab {
                padding: 0.5rem 1rem;
                font-size: 0.85rem;
                font-weight: 500;
                font-family: inherit;
                border: none;
                border-radius: 8px;
                background: transparent;
                color: var(--text-muted);
                cursor: pointer;
                transition: all 0.2s ease;
              }

              .search-tab:hover {
                color: var(--text-secondary);
              }

              .search-tab.active {
                background: var(--accent);
                color: white;
              }

              /* Category filters */
              .category-filters {
                display: flex;
                gap: 0.5rem;
                flex-wrap: wrap;
                margin-bottom: 1.5rem;
                padding-bottom: 1rem;
                border-bottom: 1px solid var(--border);
              }

              .filter-chip {
                display: inline-flex;
                align-items: center;
                gap: 0.4rem;
                padding: 0.4rem 0.9rem;
                font-size: 0.8rem;
                font-weight: 500;
                font-family: inherit;
                border: 1px solid var(--border);
                border-radius: 50px;
                background: transparent;
                color: var(--text-secondary);
                cursor: pointer;
                transition: all 0.2s ease;
              }

              .filter-chip:hover {
                border-color: var(--accent);
                color: var(--accent);
              }

              .filter-chip.active {
                background: var(--accent);
                border-color: var(--accent);
                color: white;
              }

              .filter-chip .chip-icon { font-size: 0.9rem; }

              /* Document grid */
              .doc-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
                gap: 1rem;
              }

              .doc-card {
                background: var(--card-bg);
                border: 1px solid var(--border);
                border-radius: var(--radius);
                overflow: hidden;
                transition: all 0.25s ease;
                cursor: pointer;
              }

              .doc-card:hover {
                border-color: rgba(14, 165, 233, 0.4);
                transform: translateY(-2px);
                box-shadow: var(--shadow-lg);
              }

              .doc-card-inner {
                display: flex;
                gap: 1rem;
                padding: 1rem;
              }

              .doc-thumb {
                width: 70px;
                height: 90px;
                background: var(--primary-light);
                border-radius: 8px;
                overflow: hidden;
                flex-shrink: 0;
                border: 1px solid var(--border);
              }

              .doc-thumb img {
                width: 100%;
                height: 100%;
                object-fit: cover;
              }

              .doc-content {
                flex: 1;
                min-width: 0;
                display: flex;
                flex-direction: column;
              }

              .doc-category {
                font-size: 0.7rem;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.05em;
                color: var(--accent);
                margin-bottom: 0.25rem;
              }

              .doc-title {
                font-size: 0.95rem;
                font-weight: 600;
                color: var(--text);
                margin-bottom: 0.5rem;
                line-height: 1.3;
              }

              .doc-meta {
                margin-top: auto;
                display: flex;
                align-items: center;
                gap: 0.75rem;
              }

              .doc-number {
                font-size: 0.75rem;
                font-family: monospace;
                color: var(--text-muted);
                background: rgba(255, 255, 255, 0.05);
                padding: 0.2rem 0.5rem;
                border-radius: 4px;
              }

              .doc-actions {
                display: flex;
                gap: 0.5rem;
                margin-left: auto;
              }

              .doc-action {
                width: 32px;
                height: 32px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 8px;
                font-size: 0.9rem;
                text-decoration: none;
                transition: all 0.2s ease;
                border: 1px solid var(--border);
                background: rgba(255, 255, 255, 0.03);
                color: var(--text-secondary);
              }

              .doc-action:hover {
                background: var(--accent);
                border-color: var(--accent);
                color: white;
              }

              .doc-action-download:hover {
                background: var(--success);
                border-color: var(--success);
              }

              /* Content search results */
              .content-results {
                display: none;
              }

              .content-results.visible {
                display: block;
              }

              .result-item {
                background: var(--card-bg);
                border: 1px solid var(--border);
                border-radius: var(--radius);
                padding: 1rem 1.25rem;
                margin-bottom: 0.75rem;
                cursor: pointer;
                transition: all 0.2s ease;
              }

              .result-item:hover {
                border-color: var(--accent);
                background: rgba(14, 165, 233, 0.05);
              }

              .result-header {
                display: flex;
                align-items: center;
                gap: 0.75rem;
                margin-bottom: 0.5rem;
                flex-wrap: wrap;
              }

              .result-num {
                font-size: 0.75rem;
                font-family: monospace;
                color: var(--accent);
                background: rgba(14, 165, 233, 0.1);
                padding: 0.15rem 0.5rem;
                border-radius: 4px;
              }

              .result-title {
                font-weight: 600;
                color: var(--text);
              }

              .result-page {
                font-size: 0.7rem;
                font-weight: 600;
                color: var(--success);
                background: rgba(16, 185, 129, 0.15);
                padding: 0.15rem 0.5rem;
                border-radius: 4px;
              }

              .result-category {
                font-size: 0.75rem;
                color: var(--text-muted);
                margin-left: auto;
              }

              .result-snippet {
                font-size: 0.85rem;
                color: var(--text-secondary);
                line-height: 1.6;
              }

              .result-snippet mark {
                background: rgba(14, 165, 233, 0.3);
                color: var(--text);
                padding: 0.1rem 0.2rem;
                border-radius: 3px;
              }

              /* Category sections */
              .category-section {
                margin-bottom: 2.5rem;
              }

              .category-header {
                display: flex;
                align-items: center;
                gap: 0.75rem;
                margin-bottom: 1rem;
                padding-bottom: 0.75rem;
                border-bottom: 1px solid var(--border);
              }

              .category-icon {
                font-size: 1.5rem;
              }

              .category-title {
                font-size: 1.25rem;
                font-weight: 600;
                color: var(--text);
              }

              .category-count {
                font-size: 0.8rem;
                color: var(--text-muted);
                background: rgba(255, 255, 255, 0.05);
                padding: 0.2rem 0.6rem;
                border-radius: 50px;
                margin-left: auto;
              }

              /* Loading & Empty states */
              .loading-state, .empty-state {
                text-align: center;
                padding: 3rem 1.5rem;
                color: var(--text-muted);
              }

              .empty-state-icon {
                font-size: 3rem;
                margin-bottom: 1rem;
                opacity: 0.5;
              }

              /* Footer */
              .footer {
                text-align: center;
                padding: 3rem 1.5rem;
                border-top: 1px solid var(--border);
                color: var(--text-muted);
                font-size: 0.85rem;
              }

              .footer-links {
                display: flex;
                justify-content: center;
                gap: 1.5rem;
                margin-bottom: 1rem;
                flex-wrap: wrap;
              }

              .footer a {
                color: var(--text-secondary);
                text-decoration: none;
                transition: color 0.2s;
              }

              .footer a:hover { color: var(--accent); }

              /* Utilities */
              .hidden { display: none !important; }

              /* Responsive */
              @media (max-width: 768px) {
                .header-inner { padding: 0.5rem 1rem; }
                .hero { padding: 2.5rem 1rem 2rem; }
                .hero h1 { font-size: 1.75rem; }
                .hero p { font-size: 1rem; }
                .hero-stats { gap: 1.5rem; }
                .stat-value { font-size: 1.5rem; }
                .main { padding: 0 1rem 3rem; }
                .doc-grid { grid-template-columns: 1fr; }
                .doc-card-inner { padding: 0.875rem; }
                .doc-thumb { width: 60px; height: 78px; }
                .btn span:not(.btn-icon) { display: none; }
                .btn { padding: 0.5rem; }
                .category-filters { gap: 0.4rem; }
                .filter-chip { padding: 0.35rem 0.7rem; font-size: 0.75rem; }
                .result-header { gap: 0.5rem; }
                .result-category { display: none; }
              }

              @media (max-width: 480px) {
                .hero-stats { gap: 1rem; }
                .stat { min-width: 80px; }
                .search-tabs { width: 100%; }
                .search-tab { flex: 1; text-align: center; }
                .doc-title { font-size: 0.9rem; }
              }

              /* Reduce motion for accessibility */
              @media (prefers-reduced-motion: reduce) {
                *, *::before, *::after {
                  animation-duration: 0.01ms !important;
                  transition-duration: 0.01ms !important;
                }
              }
            </style>
          </head>
          <body>
            <div class="bg-gradient"></div>

            <!-- Sticky Header -->
            <header class="header">
              <div class="header-inner">
                <a href="#" class="logo">
                  <span class="logo-icon">üõ°Ô∏è</span>
                  <span>OT Security Notes</span>
                </a>
                <div class="search-container">
                  <span class="search-icon">üîç</span>
                  <input type="text" class="search-input" id="search" placeholder="Search documents or content..." autocomplete="off">
                </div>
                <div class="header-actions">
                  <a href="https://github.com/mniedermaier/OTsecNotes" class="btn" target="_blank" rel="noopener">
                    <span class="btn-icon">üì¶</span>
                    <span>GitHub</span>
                  </a>
                  <a href="OTsecNotes-all-documents.zip" class="btn btn-primary" download>
                    <span class="btn-icon">‚¨áÔ∏è</span>
                    <span>Download All</span>
                  </a>
                </div>
              </div>
            </header>

            <!-- Hero Section -->
            <section class="hero">
              <div class="hero-badge">üìö Free Learning Resources</div>
              <h1>OT Security Notes</h1>
              <p>Comprehensive learning documents for ICS/SCADA security professionals. Vendor-neutral, standards-based, and focused on practical knowledge.</p>
              <div class="hero-stats">
                <div class="stat">
                  <div class="stat-value">PDF_COUNT</div>
                  <div class="stat-label">Documents</div>
                </div>
                <div class="stat">
                  <div class="stat-value">&lt;10</div>
                  <div class="stat-label">Pages Each</div>
                </div>
                <div class="stat">
                  <div class="stat-value">CC BY-SA</div>
                  <div class="stat-label">License</div>
                </div>
              </div>
            </section>

            <!-- Main Content -->
            <main class="main">
              <!-- Search Mode Toggle -->
              <div class="search-tabs">
                <button class="search-tab active" id="mode-title" onclick="setSearchMode('title')">üìÑ Titles</button>
                <button class="search-tab" id="mode-content" onclick="setSearchMode('content')">üìñ Full Text</button>
              </div>

              <!-- Category Filters -->
              <div class="category-filters" id="category-filters">
                <button class="filter-chip active" data-filter="all" onclick="filterCategory('all')">All</button>
          HTMLEOF

          # Define categories with icons
          declare -A CATEGORIES
          declare -A ICONS
          CATEGORIES["001-099"]="Fundamentals"
          CATEGORIES["100-199"]="Standards & Compliance"
          CATEGORIES["200-299"]="Protocols & Technologies"
          CATEGORIES["300-399"]="Architecture & Design"
          CATEGORIES["400-499"]="Threats & Attacks"
          CATEGORIES["500-599"]="Detection & Monitoring"
          CATEGORIES["600-699"]="Incident Response"
          CATEGORIES["700-799"]="Assessments"
          CATEGORIES["800-899"]="Solutions & Tools"

          ICONS["001-099"]="üí°"
          ICONS["100-199"]="üìú"
          ICONS["200-299"]="üîå"
          ICONS["300-399"]="üèóÔ∏è"
          ICONS["400-499"]="üíÄ"
          ICONS["500-599"]="üîç"
          ICONS["600-699"]="üö®"
          ICONS["700-799"]="üìã"
          ICONS["800-899"]="üîß"

          # Generate category filter chips directly in the HTML
          for range in "001-099" "100-199" "200-299" "300-399" "400-499" "500-599" "600-699" "700-799" "800-899"; do
            category_name="${CATEGORIES[$range]}"
            category_icon="${ICONS[$range]}"
            start=${range%-*}
            end=${range#*-}
            has_docs=$(ls public/*.pdf 2>/dev/null | xargs -I {} basename {} .pdf | grep -E "^[0-9]{3}-" | while read name; do
              num=${name%%-*}
              if [ "$num" -ge "$start" ] && [ "$num" -le "$end" ]; then
                echo "yes"
                break
              fi
            done)
            if [ -n "$has_docs" ]; then
              echo "                <button class=\"filter-chip\" data-filter=\"$category_name\" onclick=\"filterCategory('$category_name')\"><span class=\"chip-icon\">$category_icon</span> $category_name</button>" >> public/index.html
            fi
          done

          # Close the category-filters div and continue
          echo "              </div>" >> public/index.html
          echo "" >> public/index.html
          echo "              <!-- Loading State -->" >> public/index.html
          echo "              <div class=\"loading-state hidden\" id=\"loading-state\">Loading search index...</div>" >> public/index.html
          echo "" >> public/index.html
          echo "              <!-- Content Search Results -->" >> public/index.html
          echo "              <div class=\"content-results\" id=\"content-results\"></div>" >> public/index.html
          echo "" >> public/index.html
          echo "              <!-- Empty State -->" >> public/index.html
          echo "              <div class=\"empty-state hidden\" id=\"empty-state\">" >> public/index.html
          echo "                <div class=\"empty-state-icon\">üîç</div>" >> public/index.html
          echo "                <p>No documents found matching your search.</p>" >> public/index.html
          echo "              </div>" >> public/index.html
          echo "" >> public/index.html
          echo "              <!-- Document Categories -->" >> public/index.html
          echo "              <div id=\"categories\">" >> public/index.html

          # Generate document cards by category
          for range in "001-099" "100-199" "200-299" "300-399" "400-499" "500-599" "600-699" "700-799" "800-899"; do
            start=${range%-*}
            end=${range#*-}
            category_name="${CATEGORIES[$range]}"
            category_icon="${ICONS[$range]}"

            pdfs=$(ls public/*.pdf 2>/dev/null | xargs -I {} basename {} .pdf | grep -E "^[0-9]{3}-" | while read name; do
              num=${name%%-*}
              if [ "$num" -ge "$start" ] && [ "$num" -le "$end" ]; then
                echo "$name"
              fi
            done | sort)

            if [ -n "$pdfs" ]; then
              doc_count=$(echo "$pdfs" | wc -l)
              echo "              <section class=\"category-section\" data-category=\"$category_name\">" >> public/index.html
              echo "                <div class=\"category-header\">" >> public/index.html
              echo "                  <span class=\"category-icon\">$category_icon</span>" >> public/index.html
              echo "                  <h2 class=\"category-title\">$category_name</h2>" >> public/index.html
              echo "                  <span class=\"category-count\">$doc_count docs</span>" >> public/index.html
              echo "                </div>" >> public/index.html
              echo "                <div class=\"doc-grid\">" >> public/index.html

              echo "$pdfs" | while read pdf_name; do
                doc_num=${pdf_name%%-*}
                # Title case, then fix common abbreviations and lowercase minor words
                title=$(echo "${pdf_name#*-}" | sed 's/-/ /g' | sed 's/\b\(.\)/\u\1/g' | \
                  sed 's/\bIt\b/IT/g; s/\bOt\b/OT/g; s/\bPlc\b/PLC/g; s/\bIec\b/IEC/g; s/\bNist\b/NIST/g' | \
                  sed 's/\bDmz\b/DMZ/g; s/\bOpc\b/OPC/g; s/\bUa\b/UA/g; s/\bDnp3\b/DNP3/g; s/\bIds\b/IDS/g' | \
                  sed 's/\bNerc\b/NERC/g; s/\bCip\b/CIP/g; s/\bSp\b/SP/g; s/\bIr\b/IR/g; s/\bTrisis\b/TRISIS/g' | \
                  sed 's/\bIps\b/IPS/g; s/\bSiem\b/SIEM/g; s/\bHmi\b/HMI/g; s/\bScada\b/SCADA/g' | \
                  sed 's/\bSis\b/SIS/g; s/\bBacnet\b/BACnet/g' | \
                  sed 's/ Vs / vs /g; s/ And / and /g; s/ Or / or /g; s/ The / the /g; s/ A / a /g; s/ An / an /g; s/ In / in /g; s/ For / for /g')
                echo "                  <article class=\"doc-card\" data-title=\"$title\" data-category=\"$category_name\" onclick=\"window.location='viewer.html?file=${pdf_name}.pdf'\">" >> public/index.html
                echo "                    <div class=\"doc-card-inner\">" >> public/index.html
                echo "                      <div class=\"doc-thumb\"><img src=\"thumbnails/${pdf_name}.png\" alt=\"\" loading=\"lazy\"></div>" >> public/index.html
                echo "                      <div class=\"doc-content\">" >> public/index.html
                echo "                        <div class=\"doc-category\">$category_name</div>" >> public/index.html
                echo "                        <h3 class=\"doc-title\">$title</h3>" >> public/index.html
                echo "                        <div class=\"doc-meta\">" >> public/index.html
                echo "                          <span class=\"doc-number\">#$doc_num</span>" >> public/index.html
                echo "                          <div class=\"doc-actions\">" >> public/index.html
                echo "                            <a href=\"viewer.html?file=${pdf_name}.pdf\" class=\"doc-action\" title=\"View\" onclick=\"event.stopPropagation()\">üëÅÔ∏è</a>" >> public/index.html
                echo "                            <a href=\"${pdf_name}.pdf\" class=\"doc-action doc-action-download\" title=\"Download\" download onclick=\"event.stopPropagation()\">‚¨áÔ∏è</a>" >> public/index.html
                echo "                          </div>" >> public/index.html
                echo "                        </div>" >> public/index.html
                echo "                      </div>" >> public/index.html
                echo "                    </div>" >> public/index.html
                echo "                  </article>" >> public/index.html
              done

              echo "                </div>" >> public/index.html
              echo "              </section>" >> public/index.html
            fi
          done

          cat >> public/index.html << 'HTMLEOF'
              </div>
            </main>

            <!-- Footer -->
            <footer class="footer">
              <div class="footer-links">
                <a href="https://github.com/mniedermaier/OTsecNotes">GitHub Repository</a>
                <a href="https://github.com/mniedermaier/OTsecNotes/issues/new?template=new-document-request.yml">Request Document</a>
                <a href="https://github.com/mniedermaier/OTsecNotes/issues">Report Issue</a>
              </div>
              <p>Last updated: TIMESTAMP ¬∑ Created with AI assistance ¬∑ Licensed under CC BY-SA 4.0</p>
            </footer>

            <script>
              // State
              let searchMode = 'title';
              let activeFilter = 'all';
              let searchIndex = null;
              let flattenedIndex = null;
              let fuse = null;

              // DOM elements
              const searchInput = document.getElementById('search');
              const categorySections = document.querySelectorAll('.category-section');
              const docCards = document.querySelectorAll('.doc-card');
              const contentResults = document.getElementById('content-results');
              const emptyState = document.getElementById('empty-state');
              const loadingState = document.getElementById('loading-state');

              // Load search index
              async function loadSearchIndex() {
                try {
                  const response = await fetch('search-index.json');
                  searchIndex = await response.json();
                  flattenedIndex = [];
                  searchIndex.forEach(doc => {
                    doc.pages.forEach(pageData => {
                      flattenedIndex.push({
                        id: doc.id,
                        num: doc.num,
                        title: doc.title,
                        category: doc.category,
                        totalPages: doc.totalPages,
                        page: pageData.page,
                        text: pageData.text
                      });
                    });
                  });
                  fuse = new Fuse(flattenedIndex, {
                    keys: ['title', 'text'],
                    threshold: 0.3,
                    includeMatches: true,
                    minMatchCharLength: 3,
                    ignoreLocation: true
                  });
                  console.log('Search index loaded:', searchIndex.length, 'docs,', flattenedIndex.length, 'pages');
                } catch (e) {
                  console.error('Failed to load search index:', e);
                }
              }

              // Set search mode
              function setSearchMode(mode) {
                searchMode = mode;
                document.getElementById('mode-title').classList.toggle('active', mode === 'title');
                document.getElementById('mode-content').classList.toggle('active', mode === 'content');
                performSearch(searchInput.value);
              }

              // Filter by category
              function filterCategory(category) {
                activeFilter = category;
                document.querySelectorAll('.filter-chip').forEach(chip => {
                  chip.classList.toggle('active', chip.dataset.filter === category);
                });
                performSearch(searchInput.value);
              }

              // Get snippet with highlighting
              function getSnippet(text, query) {
                const lowerText = text.toLowerCase();
                const lowerQuery = query.toLowerCase();
                const idx = lowerText.indexOf(lowerQuery);
                if (idx === -1) return text.slice(0, 180) + '...';
                const start = Math.max(0, idx - 50);
                const end = Math.min(text.length, idx + query.length + 130);
                let snippet = (start > 0 ? '...' : '') + text.slice(start, end) + (end < text.length ? '...' : '');
                const regex = new RegExp('(' + query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi');
                return snippet.replace(regex, '<mark>$1</mark>');
              }

              // Perform search
              function performSearch(query) {
                query = query.trim();
                const lowerQuery = query.toLowerCase();

                if (searchMode === 'title') {
                  contentResults.classList.remove('visible');
                  document.getElementById('categories').style.display = '';

                  let hasResults = false;
                  categorySections.forEach(section => {
                    const sectionCategory = section.dataset.category;
                    const matchesFilter = activeFilter === 'all' || sectionCategory === activeFilter;

                    if (!matchesFilter) {
                      section.classList.add('hidden');
                      return;
                    }

                    const cards = section.querySelectorAll('.doc-card');
                    let sectionHasMatch = false;

                    cards.forEach(card => {
                      const title = card.dataset.title.toLowerCase();
                      const matchesSearch = !query || title.includes(lowerQuery);
                      card.classList.toggle('hidden', !matchesSearch);
                      if (matchesSearch) sectionHasMatch = true;
                    });

                    section.classList.toggle('hidden', !sectionHasMatch);
                    if (sectionHasMatch) hasResults = true;
                  });

                  emptyState.classList.toggle('hidden', hasResults || !query);

                } else {
                  // Content search
                  document.getElementById('categories').style.display = 'none';

                  if (!query || query.length < 2) {
                    contentResults.classList.remove('visible');
                    document.getElementById('categories').style.display = '';
                    emptyState.classList.add('hidden');
                    filterCategory(activeFilter);
                    return;
                  }

                  if (!fuse) {
                    loadingState.classList.remove('hidden');
                    loadSearchIndex().then(() => {
                      loadingState.classList.add('hidden');
                      performSearch(query);
                    });
                    return;
                  }

                  let results = fuse.search(query, { limit: 50 });

                  // Filter by category if active
                  if (activeFilter !== 'all') {
                    results = results.filter(r => r.item.category === activeFilter);
                  }

                  contentResults.innerHTML = '';

                  if (results.length === 0) {
                    contentResults.classList.remove('visible');
                    emptyState.classList.remove('hidden');
                    return;
                  }

                  emptyState.classList.add('hidden');
                  contentResults.classList.add('visible');

                  // Group by document
                  const seen = new Map();
                  results.forEach(result => {
                    const doc = result.item;
                    if (!seen.has(doc.id)) seen.set(doc.id, []);
                    if (seen.get(doc.id).length < 3) seen.get(doc.id).push(doc);
                  });

                  seen.forEach((pages) => {
                    pages.forEach(doc => {
                      const item = document.createElement('div');
                      item.className = 'result-item';
                      item.onclick = () => window.location.href = 'viewer.html?file=' + doc.id + '.pdf&page=' + doc.page;
                      item.innerHTML =
                        '<div class="result-header">' +
                          '<span class="result-num">#' + doc.num + '</span>' +
                          '<span class="result-title">' + doc.title + '</span>' +
                          '<span class="result-page">Page ' + doc.page + '/' + doc.totalPages + '</span>' +
                          '<span class="result-category">' + doc.category + '</span>' +
                        '</div>' +
                        '<div class="result-snippet">' + getSnippet(doc.text, query) + '</div>';
                      contentResults.appendChild(item);
                    });
                  });
                }
              }

              // Debounced search
              let searchTimeout;
              searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => performSearch(e.target.value), 150);
              });

              // Initialize
              loadSearchIndex();
            </script>
          </body>
          </html>
          HTMLEOF

          # Replace placeholders
          sed -i "s/TIMESTAMP/$(date -u +'%Y-%m-%d %H:%M UTC')/g" public/index.html
          sed -i "s/PDF_COUNT/$PDF_COUNT/g" public/index.html

      - name: Setup Pages
        uses: actions/configure-pages@v4
        with:
          enablement: true

      - name: Upload to Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: public/

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
