name: Build PDFs

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:  # Allow manual trigger

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install LaTeX
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            texlive-latex-extra \
            texlive-fonts-extra \
            texlive-fonts-recommended \
            texlive-pictures \
            texlive-latex-recommended \
            texlive-lang-greek \
            latexmk \
            poppler-utils

      - name: Build all PDFs
        run: make parallel

      - name: Collect PDFs and generate thumbnails
        run: |
          mkdir -p pdf-output
          mkdir -p pdf-output/thumbnails
          find . -path './[0-9]*-*/[0-9]*-*/*.pdf' -exec cp {} pdf-output/ \;

          # Generate thumbnails for each PDF (first page only)
          for pdf in pdf-output/*.pdf; do
            filename=$(basename "$pdf" .pdf)
            pdftoppm -png -f 1 -l 1 -scale-to 400 "$pdf" "pdf-output/thumbnails/${filename}"
            # pdftoppm adds -1 or -01 suffix depending on version, rename it
            mv "pdf-output/thumbnails/${filename}-1.png" "pdf-output/thumbnails/${filename}.png" 2>/dev/null || \
            mv "pdf-output/thumbnails/${filename}-01.png" "pdf-output/thumbnails/${filename}.png" 2>/dev/null || true
          done

          # Generate search index from PDF text content
          chmod +x scripts/generate-search-index.sh
          ./scripts/generate-search-index.sh pdf-output pdf-output/search-index.json

          # Create ZIP of all PDFs for "Download All" button
          cd pdf-output
          zip -r OTsecNotes-all-documents.zip *.pdf
          cd ..

          echo "PDFs:"
          ls -la pdf-output/*.pdf
          echo "Thumbnails:"
          ls -la pdf-output/thumbnails/
          echo "Search index:"
          ls -la pdf-output/search-index.json
          echo "ZIP:"
          ls -la pdf-output/*.zip

      - name: Check page count (max 10 pages)
        run: |
          MAX_PAGES=10
          FAILED=0
          echo "üìÑ Checking document page counts (max: $MAX_PAGES pages)"
          echo "================================================"
          for pdf in pdf-output/*.pdf; do
            filename=$(basename "$pdf")
            pages=$(pdfinfo "$pdf" | grep "^Pages:" | awk '{print $2}')
            if [ "$pages" -gt "$MAX_PAGES" ]; then
              echo "‚ùå FAIL: $filename has $pages pages (exceeds $MAX_PAGES)"
              FAILED=1
            else
              echo "‚úÖ OK: $filename ($pages pages)"
            fi
          done
          echo "================================================"
          if [ "$FAILED" -eq 1 ]; then
            echo "::error::One or more documents exceed the $MAX_PAGES page limit. Please reduce content."
            exit 1
          fi
          echo "‚úÖ All documents are within the $MAX_PAGES page limit."

      - name: Upload PDFs as artifact
        uses: actions/upload-artifact@v4
        with:
          name: pdf-documents
          path: pdf-output/
          retention-days: 30

  # Deploy to GitHub Pages (only on push to main)
  deploy:
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download PDFs artifact
        uses: actions/download-artifact@v4
        with:
          name: pdf-documents
          path: public/

      - name: Copy viewer page
        run: |
          cp pages/viewer.html public/viewer.html

      - name: Generate index page
        run: |
          PDF_COUNT=$(ls public/*.pdf 2>/dev/null | wc -l)

          cat > public/index.html << 'HTMLEOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>OT Security Notes - ICS/SCADA Security Learning Resources</title>
            <meta name="description" content="Comprehensive learning documents for ICS/SCADA security professionals covering OT fundamentals, standards, protocols, and incident response.">
            <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üõ°Ô∏è</text></svg>">
            <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0/dist/fuse.min.js"></script>
            <style>
              :root {
                --primary: #0f172a;
                --accent: #0ea5e9;
                --bg: #0f172a;
                --card-bg: rgba(30, 41, 59, 0.85);
                --text: #e2e8f0;
                --text-muted: #94a3b8;
                --border: rgba(71, 85, 105, 0.5);
              }
              * { box-sizing: border-box; margin: 0; padding: 0; }
              body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
                color: var(--text);
                line-height: 1.6;
                min-height: 100vh;
              }
              #particles-canvas {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: 0;
                pointer-events: none;
              }
              .glow-orb {
                position: fixed;
                border-radius: 50%;
                filter: blur(100px);
                opacity: 0.4;
                z-index: 0;
                pointer-events: none;
              }
              .glow-orb-1 {
                width: 500px;
                height: 500px;
                background: radial-gradient(circle, #0ea5e9 0%, transparent 70%);
                top: -150px;
                left: -150px;
                animation: orbFloat1 25s ease-in-out infinite;
              }
              .glow-orb-2 {
                width: 400px;
                height: 400px;
                background: radial-gradient(circle, #8b5cf6 0%, transparent 70%);
                bottom: -100px;
                right: -100px;
                animation: orbFloat2 30s ease-in-out infinite;
              }
              .glow-orb-3 {
                width: 350px;
                height: 350px;
                background: radial-gradient(circle, #10b981 0%, transparent 70%);
                top: 40%;
                right: 20%;
                animation: orbFloat3 20s ease-in-out infinite;
              }
              .glow-orb-4 {
                width: 300px;
                height: 300px;
                background: radial-gradient(circle, #f59e0b 0%, transparent 70%);
                bottom: 30%;
                left: 10%;
                animation: orbFloat4 22s ease-in-out infinite;
              }
              @keyframes orbFloat1 {
                0%, 100% { transform: translate(0, 0) scale(1); }
                33% { transform: translate(100px, 50px) scale(1.2); }
                66% { transform: translate(50px, 100px) scale(0.9); }
              }
              @keyframes orbFloat2 {
                0%, 100% { transform: translate(0, 0) scale(1); }
                33% { transform: translate(-80px, -40px) scale(1.1); }
                66% { transform: translate(-40px, -80px) scale(0.95); }
              }
              @keyframes orbFloat3 {
                0%, 100% { transform: translate(0, 0) scale(1); }
                50% { transform: translate(-60px, 60px) scale(1.15); }
              }
              @keyframes orbFloat4 {
                0%, 100% { transform: translate(0, 0) scale(1); }
                50% { transform: translate(70px, -50px) scale(1.1); }
              }
              .hero {
                position: relative;
                z-index: 1;
                color: white;
                padding: 5rem 1.5rem;
                text-align: center;
                min-height: 450px;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
              }
              .hero-icon {
                font-size: 5rem;
                margin-bottom: 1.5rem;
                animation: pulse-glow 2s ease-in-out infinite;
                filter: drop-shadow(0 0 40px rgba(14, 165, 233, 0.6));
              }
              @keyframes pulse-glow {
                0%, 100% { transform: scale(1); filter: drop-shadow(0 0 40px rgba(14, 165, 233, 0.6)); }
                50% { transform: scale(1.1); filter: drop-shadow(0 0 60px rgba(14, 165, 233, 0.9)); }
              }
              .hero h1 {
                font-size: 3.5rem;
                font-weight: 800;
                margin-bottom: 1rem;
                background: linear-gradient(135deg, #ffffff 0%, #0ea5e9 40%, #8b5cf6 60%, #ffffff 100%);
                background-size: 300% auto;
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
                animation: shine 4s linear infinite;
              }
              @keyframes shine {
                to { background-position: 300% center; }
              }
              .hero-subtitle {
                font-size: 1.25rem;
                opacity: 0.9;
                max-width: 650px;
                margin: 0 auto 2rem;
                line-height: 1.8;
              }
              .badges {
                display: flex;
                gap: 1rem;
                justify-content: center;
                flex-wrap: wrap;
              }
              .badge {
                display: inline-flex;
                align-items: center;
                gap: 0.5rem;
                background: rgba(255,255,255,0.08);
                border: 1px solid rgba(255,255,255,0.15);
                padding: 0.6rem 1.2rem;
                border-radius: 9999px;
                font-size: 0.95rem;
                backdrop-filter: blur(20px);
                transition: all 0.3s ease;
              }
              .badge:hover {
                background: rgba(255,255,255,0.15);
                transform: translateY(-3px);
                box-shadow: 0 15px 40px rgba(0,0,0,0.4);
              }
              .download-all-btn {
                display: inline-flex;
                align-items: center;
                gap: 0.6rem;
                margin-top: 2rem;
                padding: 1rem 2rem;
                background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                border: none;
                border-radius: 12px;
                color: white;
                font-size: 1.1rem;
                font-weight: 700;
                text-decoration: none;
                transition: all 0.3s ease;
                box-shadow: 0 4px 20px rgba(16, 185, 129, 0.4);
              }
              .download-all-btn:hover {
                transform: translateY(-3px);
                box-shadow: 0 8px 30px rgba(16, 185, 129, 0.5);
              }
              .container {
                position: relative;
                z-index: 1;
                max-width: 1000px;
                margin: 0 auto;
                padding: 2rem 1.5rem 4rem;
              }
              .controls {
                display: flex;
                gap: 1rem;
                margin-bottom: 1rem;
                align-items: center;
              }
              .search-box {
                flex: 1;
                position: relative;
              }
              .search-box input {
                width: 100%;
                padding: 1.1rem 1.5rem;
                font-size: 1.05rem;
                border: 1px solid var(--border);
                border-radius: 16px;
                background: rgba(30, 41, 59, 0.7);
                color: var(--text);
                transition: all 0.3s ease;
                box-shadow: 0 4px 20px rgba(0,0,0,0.2);
                backdrop-filter: blur(20px);
              }
              .search-box input:focus {
                outline: none;
                border-color: var(--accent);
                box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.2), 0 15px 50px rgba(0,0,0,0.3);
                transform: translateY(-2px);
                background: rgba(30, 41, 59, 0.9);
              }
              .search-box input::placeholder { color: var(--text-muted); }
              .toggle-btn {
                padding: 1.1rem 1.5rem;
                font-size: 0.95rem;
                font-weight: 600;
                border: 1px solid var(--border);
                border-radius: 16px;
                background: rgba(30, 41, 59, 0.7);
                color: var(--text);
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 4px 20px rgba(0,0,0,0.2);
                backdrop-filter: blur(20px);
                white-space: nowrap;
              }
              .toggle-btn:hover {
                border-color: var(--accent);
                background: rgba(14, 165, 233, 0.2);
                transform: translateY(-2px);
                box-shadow: 0 8px 30px rgba(0,0,0,0.3);
              }
              .toggle-btn.active {
                background: rgba(14, 165, 233, 0.3);
                border-color: var(--accent);
              }
              .search-mode-toggle {
                display: flex;
                gap: 0.5rem;
                margin-bottom: 1.5rem;
              }
              .search-mode-btn {
                padding: 0.6rem 1rem;
                font-size: 0.85rem;
                font-weight: 500;
                border: 1px solid var(--border);
                border-radius: 10px;
                background: rgba(30, 41, 59, 0.5);
                color: var(--text-muted);
                cursor: pointer;
                transition: all 0.2s ease;
              }
              .search-mode-btn:hover {
                background: rgba(30, 41, 59, 0.8);
                color: var(--text);
              }
              .search-mode-btn.active {
                background: linear-gradient(135deg, rgba(14, 165, 233, 0.3) 0%, rgba(139, 92, 246, 0.3) 100%);
                border-color: var(--accent);
                color: var(--text);
              }
              .content-results {
                margin-bottom: 2rem;
                display: none;
              }
              .content-results.visible {
                display: block;
              }
              .content-result-item {
                background: var(--card-bg);
                border: 1px solid var(--border);
                border-radius: 12px;
                padding: 1rem 1.25rem;
                margin-bottom: 0.75rem;
                transition: all 0.2s ease;
                cursor: pointer;
              }
              .content-result-item:hover {
                border-color: var(--accent);
                transform: translateX(4px);
              }
              .content-result-header {
                display: flex;
                align-items: center;
                gap: 0.75rem;
                margin-bottom: 0.5rem;
              }
              .content-result-num {
                font-family: monospace;
                font-size: 0.75rem;
                color: var(--accent);
                background: rgba(14, 165, 233, 0.1);
                padding: 0.2rem 0.5rem;
                border-radius: 4px;
              }
              .content-result-title {
                font-weight: 600;
                color: var(--text);
              }
              .content-result-category {
                font-size: 0.75rem;
                color: var(--text-muted);
                margin-left: auto;
              }
              .content-result-page {
                font-size: 0.7rem;
                color: #10b981;
                background: rgba(16, 185, 129, 0.15);
                padding: 0.2rem 0.5rem;
                border-radius: 4px;
                font-weight: 600;
              }
              .content-result-snippet {
                font-size: 0.85rem;
                color: var(--text-muted);
                line-height: 1.5;
              }
              .content-result-snippet mark {
                background: rgba(14, 165, 233, 0.3);
                color: var(--text);
                padding: 0 2px;
                border-radius: 2px;
              }
              .search-loading {
                text-align: center;
                padding: 2rem;
                color: var(--text-muted);
                display: none;
              }
              .search-loading.visible {
                display: block;
              }
              .categories { display: grid; gap: 1.75rem; }
              .category {
                background: var(--card-bg);
                border-radius: 20px;
                overflow: hidden;
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                border: 1px solid var(--border);
                transition: all 0.3s ease;
                backdrop-filter: blur(20px);
              }
              .category:hover {
                transform: translateY(-6px);
                box-shadow: 0 25px 60px rgba(0,0,0,0.4);
                border-color: rgba(14, 165, 233, 0.3);
              }
              .category-header {
                display: flex;
                align-items: center;
                gap: 1rem;
                padding: 1.25rem 1.5rem;
                background: linear-gradient(135deg, rgba(30, 41, 59, 0.5) 0%, rgba(15, 23, 42, 0.5) 100%);
                border-bottom: 1px solid var(--border);
                cursor: pointer;
                user-select: none;
                transition: background 0.2s ease;
              }
              .category-header:hover {
                background: linear-gradient(135deg, rgba(40, 51, 69, 0.6) 0%, rgba(25, 33, 52, 0.6) 100%);
              }
              .category.collapsed .category-header {
                border-bottom: none;
              }
              .category-icon {
                font-size: 1.75rem;
                width: 55px;
                height: 55px;
                display: flex;
                align-items: center;
                justify-content: center;
                background: linear-gradient(135deg, rgba(14, 165, 233, 0.2) 0%, rgba(139, 92, 246, 0.2) 100%);
                border-radius: 14px;
                border: 1px solid rgba(255,255,255,0.1);
              }
              .category-title { font-size: 1.2rem; font-weight: 600; color: var(--text); }
              .category-toggle {
                margin-left: auto;
                font-size: 1.2rem;
                color: var(--text-muted);
                transition: transform 0.3s ease;
              }
              .category.collapsed .category-toggle {
                transform: rotate(-90deg);
              }
              .category-range {
                font-size: 0.8rem;
                color: var(--text-muted);
                font-family: monospace;
                background: rgba(0,0,0,0.3);
                padding: 0.4rem 0.8rem;
                border-radius: 8px;
                border: 1px solid var(--border);
              }
              .doc-list {
                list-style: none;
                max-height: 2000px;
                overflow: hidden;
                transition: max-height 0.4s ease, opacity 0.3s ease;
                opacity: 1;
              }
              .category.collapsed .doc-list {
                max-height: 0;
                opacity: 0;
              }
              .doc-item {
                display: flex;
                align-items: center;
                padding: 1rem 1.5rem;
                border-bottom: 1px solid var(--border);
                transition: all 0.25s ease;
                gap: 1rem;
                position: relative;
              }
              .doc-item:last-child { border-bottom: none; }
              .doc-item:hover {
                background: linear-gradient(135deg, rgba(14, 165, 233, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
              }
              .doc-thumb {
                width: 60px;
                height: 80px;
                background: #1e293b;
                border-radius: 6px;
                overflow: hidden;
                flex-shrink: 0;
                box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                border: 1px solid var(--border);
              }
              .doc-thumb img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                transition: transform 0.3s ease;
              }
              .doc-item:hover .doc-thumb img {
                transform: scale(1.05);
              }
              .doc-info {
                flex: 1;
                min-width: 0;
              }
              .doc-num {
                font-family: monospace;
                font-size: 0.75rem;
                color: var(--accent);
                font-weight: 600;
                margin-bottom: 0.25rem;
              }
              .doc-title-text {
                color: var(--text);
                font-weight: 500;
                font-size: 1rem;
                margin-bottom: 0.25rem;
              }
              .doc-actions {
                display: flex;
                gap: 0.5rem;
                flex-shrink: 0;
              }
              .doc-btn {
                padding: 0.5rem 1rem;
                border-radius: 8px;
                font-size: 0.8rem;
                font-weight: 600;
                text-decoration: none;
                transition: all 0.2s;
                display: flex;
                align-items: center;
                gap: 0.4rem;
              }
              .doc-btn-view {
                background: linear-gradient(135deg, #0ea5e9 0%, #8b5cf6 100%);
                color: white;
              }
              .doc-btn-view:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 15px rgba(14, 165, 233, 0.4);
              }
              .doc-btn-download {
                background: rgba(255,255,255,0.05);
                border: 1px solid var(--border);
                color: var(--text-muted);
              }
              .doc-btn-download:hover {
                background: rgba(16, 185, 129, 0.2);
                border-color: #10b981;
                color: #10b981;
              }
              .footer {
                position: relative;
                z-index: 1;
                text-align: center;
                padding: 4rem 1.5rem;
                color: var(--text-muted);
                font-size: 0.95rem;
              }
              .footer a { color: var(--accent); text-decoration: none; font-weight: 500; }
              .footer a:hover { text-decoration: underline; }
              .footer-links { display: flex; justify-content: center; gap: 2.5rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
              .hidden { display: none !important; }
              .no-results { text-align: center; padding: 3rem; color: var(--text-muted); }
              @media (max-width: 768px) {
                .doc-thumb { width: 50px; height: 65px; }
                .doc-btn span:not(:first-child) { display: none; }
                .doc-btn { padding: 0.5rem 0.75rem; }
              }
              @media (max-width: 640px) {
                .hero h1 { font-size: 2.2rem; }
                .hero-icon { font-size: 3.5rem; }
                .hero { padding: 3rem 1rem; min-height: 350px; }
                .hero-subtitle { font-size: 1rem; }
                .doc-item { flex-wrap: wrap; gap: 0.75rem; padding: 0.75rem 1rem; }
                .doc-thumb { width: 45px; height: 58px; }
                .doc-info { flex: 1; min-width: 0; }
                .doc-title-text { font-size: 0.9rem; }
                .doc-actions { margin-left: auto; }
                .footer-links { gap: 1.5rem; }
                .badges { gap: 0.5rem; }
                .badge { padding: 0.4rem 0.8rem; font-size: 0.85rem; }
                .download-all-btn { padding: 0.75rem 1.5rem; font-size: 1rem; }
              }
            </style>
          </head>
          <body>
            <div class="glow-orb glow-orb-1"></div>
            <div class="glow-orb glow-orb-2"></div>
            <div class="glow-orb glow-orb-3"></div>
            <div class="glow-orb glow-orb-4"></div>
            <canvas id="particles-canvas"></canvas>
            <header class="hero">
              <div class="hero-icon">üõ°Ô∏è</div>
              <h1>OT Security Notes</h1>
              <p class="hero-subtitle">
                Comprehensive learning documents for ICS/SCADA security professionals.
                Vendor-neutral, standards-based, and focused on practical knowledge.
              </p>
              <div class="badges">
                <span class="badge">üìÑ PDF_COUNT Documents</span>
                <span class="badge">üìñ Under 10 pages each</span>
                <span class="badge">‚öñÔ∏è CC BY-SA 4.0</span>
              </div>
              <a href="OTsecNotes-all-documents.zip" class="download-all-btn" download>
                üì¶ Download All PDFs
              </a>
            </header>
            <main class="container">
              <div class="controls">
                <div class="search-box">
                  <input type="text" id="search" placeholder="üîç Search documents..." autocomplete="off">
                </div>
                <button class="toggle-btn" id="toggle-all" onclick="toggleAll()">Expand All</button>
              </div>
              <div class="search-mode-toggle">
                <button class="search-mode-btn active" id="mode-title" onclick="setSearchMode('title')">üìÑ Title Search</button>
                <button class="search-mode-btn" id="mode-content" onclick="setSearchMode('content')">üìñ Content Search</button>
              </div>
              <div class="search-loading" id="search-loading">Loading search index...</div>
              <div class="content-results" id="content-results"></div>
              <div class="categories" id="categories">
          HTMLEOF

          # Define categories with icons
          declare -A CATEGORIES
          declare -A ICONS
          CATEGORIES["001-099"]="Fundamentals"
          CATEGORIES["100-199"]="Standards & Compliance"
          CATEGORIES["200-299"]="Protocols & Technologies"
          CATEGORIES["300-399"]="Architecture & Design"
          CATEGORIES["400-499"]="Threats & Attacks"
          CATEGORIES["500-599"]="Detection & Monitoring"
          CATEGORIES["600-699"]="Incident Response"
          CATEGORIES["700-799"]="Assessments"
          CATEGORIES["800-899"]="Solutions & Tools"

          ICONS["001-099"]="üí°"
          ICONS["100-199"]="üìú"
          ICONS["200-299"]="üîå"
          ICONS["300-399"]="üèóÔ∏è"
          ICONS["400-499"]="üíÄ"
          ICONS["500-599"]="üîç"
          ICONS["600-699"]="üö®"
          ICONS["700-799"]="üìã"
          ICONS["800-899"]="üîß"

          for range in "001-099" "100-199" "200-299" "300-399" "400-499" "500-599" "600-699" "700-799" "800-899"; do
            start=${range%-*}
            end=${range#*-}
            category_name="${CATEGORIES[$range]}"
            category_icon="${ICONS[$range]}"

            pdfs=$(ls public/*.pdf 2>/dev/null | xargs -I {} basename {} .pdf | grep -E "^[0-9]{3}-" | while read name; do
              num=${name%%-*}
              if [ "$num" -ge "$start" ] && [ "$num" -le "$end" ]; then
                echo "$name"
              fi
            done | sort)

            if [ -n "$pdfs" ]; then
              echo "            <div class=\"category collapsed\" data-category=\"$category_name\">" >> public/index.html
              echo "              <div class=\"category-header\" onclick=\"this.parentElement.classList.toggle('collapsed')\">" >> public/index.html
              echo "                <span class=\"category-icon\">$category_icon</span>" >> public/index.html
              echo "                <span class=\"category-title\">$category_name</span>" >> public/index.html
              echo "                <span class=\"category-range\">$range</span>" >> public/index.html
              echo "                <span class=\"category-toggle\">‚ñº</span>" >> public/index.html
              echo "              </div>" >> public/index.html
              echo "              <ul class=\"doc-list\">" >> public/index.html

              echo "$pdfs" | while read pdf_name; do
                doc_num=${pdf_name%%-*}
                # Title case, then fix common abbreviations and lowercase minor words
                title=$(echo "${pdf_name#*-}" | sed 's/-/ /g' | sed 's/\b\(.\)/\u\1/g' | \
                  sed 's/\bIt\b/IT/g; s/\bOt\b/OT/g; s/\bPlc\b/PLC/g; s/\bIec\b/IEC/g; s/\bNist\b/NIST/g' | \
                  sed 's/\bDmz\b/DMZ/g; s/\bOpc\b/OPC/g; s/\bUa\b/UA/g; s/\bDnp3\b/DNP3/g; s/\bIds\b/IDS/g' | \
                  sed 's/\bNerc\b/NERC/g; s/\bCip\b/CIP/g; s/\bSp\b/SP/g; s/\bIr\b/IR/g; s/\bTrisis\b/TRISIS/g' | \
                  sed 's/ Vs / vs /g; s/ And / and /g; s/ Or / or /g; s/ The / the /g; s/ A / a /g; s/ An / an /g')
                echo "                <li class=\"doc-item\" data-title=\"$title\">" >> public/index.html
                echo "                  <div class=\"doc-thumb\"><img src=\"thumbnails/${pdf_name}.png\" alt=\"\" loading=\"lazy\"></div>" >> public/index.html
                echo "                  <div class=\"doc-info\">" >> public/index.html
                echo "                    <div class=\"doc-num\">Document $doc_num</div>" >> public/index.html
                echo "                    <div class=\"doc-title-text\">$title</div>" >> public/index.html
                echo "                  </div>" >> public/index.html
                echo "                  <div class=\"doc-actions\">" >> public/index.html
                echo "                    <a href=\"viewer.html?file=${pdf_name}.pdf\" class=\"doc-btn doc-btn-view\">&#128065; View</a>" >> public/index.html
                echo "                    <a href=\"${pdf_name}.pdf\" class=\"doc-btn doc-btn-download\" download>&#8595; PDF</a>" >> public/index.html
                echo "                  </div>" >> public/index.html
                echo "                </li>" >> public/index.html
              done

              echo "              </ul>" >> public/index.html
              echo "            </div>" >> public/index.html
            fi
          done

          cat >> public/index.html << 'HTMLEOF'
              </div>
              <div class="no-results hidden" id="no-results">No documents found matching your search.</div>
            </main>
            <footer class="footer">
              <div class="footer-links">
                <a href="https://github.com/mniedermaier/OTsecNotes">üì¶ GitHub Repository</a>
                <a href="https://github.com/mniedermaier/OTsecNotes/issues/new?template=new-document-request.yml">üìù Request Document</a>
                <a href="https://github.com/mniedermaier/OTsecNotes/issues">üêõ Report Issue</a>
              </div>
              <p>Last updated: TIMESTAMP</p>
              <p style="margin-top: 0.5rem;">ü§ñ Created with AI assistance ¬∑ Licensed under CC BY-SA 4.0</p>
            </footer>
            <script>
              // Toggle all categories expand/collapse
              function toggleAll() {
                const categories = document.querySelectorAll('.category');
                const btn = document.getElementById('toggle-all');
                const allCollapsed = Array.from(categories).every(c => c.classList.contains('collapsed'));

                categories.forEach(cat => {
                  if (allCollapsed) {
                    cat.classList.remove('collapsed');
                  } else {
                    cat.classList.add('collapsed');
                  }
                });

                btn.textContent = allCollapsed ? 'Collapse All' : 'Expand All';
              }

              const canvas = document.getElementById('particles-canvas');
              const ctx = canvas.getContext('2d');
              let particles = [];
              let mouse = { x: null, y: null, radius: 180 };

              function resizeCanvas() {
                canvas.width = window.innerWidth;
                canvas.height = document.documentElement.scrollHeight;
              }
              resizeCanvas();
              window.addEventListener('resize', () => { resizeCanvas(); initParticles(); });

              let lastHeight = 0;
              setInterval(() => {
                const newHeight = document.documentElement.scrollHeight;
                if (newHeight !== lastHeight) { canvas.height = newHeight; lastHeight = newHeight; }
              }, 1000);

              document.addEventListener('mousemove', (e) => {
                mouse.x = e.clientX;
                mouse.y = e.clientY + window.scrollY;
              });
              document.addEventListener('mouseleave', () => { mouse.x = null; mouse.y = null; });

              class Particle {
                constructor() {
                  this.x = Math.random() * canvas.width;
                  this.y = Math.random() * canvas.height;
                  this.size = Math.random() * 2.5 + 0.5;
                  this.speedX = (Math.random() - 0.5) * 0.8;
                  this.speedY = (Math.random() - 0.5) * 0.8;
                  this.opacity = Math.random() * 0.5 + 0.2;
                  const hue = 190 + Math.random() * 50;
                  this.color = 'hsla(' + hue + ', 80%, 65%, ' + this.opacity + ')';
                }
                draw() {
                  ctx.fillStyle = this.color;
                  ctx.beginPath();
                  ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                  ctx.fill();
                }
                update() {
                  if (mouse.x != null && mouse.y != null) {
                    let dx = mouse.x - this.x;
                    let dy = mouse.y - this.y;
                    let distance = Math.sqrt(dx * dx + dy * dy);
                    if (distance < mouse.radius) {
                      let force = (mouse.radius - distance) / mouse.radius;
                      this.x -= (dx / distance) * force * 3;
                      this.y -= (dy / distance) * force * 3;
                    }
                  }
                  this.x += this.speedX;
                  this.y += this.speedY;
                  if (this.x < 0) this.x = canvas.width;
                  if (this.x > canvas.width) this.x = 0;
                  if (this.y < 0) this.y = canvas.height;
                  if (this.y > canvas.height) this.y = 0;
                }
              }

              function initParticles() {
                particles = [];
                const num = Math.min((canvas.width * canvas.height) / 8000, 300);
                for (let i = 0; i < num; i++) particles.push(new Particle());
              }
              initParticles();

              function connectParticles() {
                for (let a = 0; a < particles.length; a++) {
                  for (let b = a + 1; b < particles.length; b++) {
                    let dx = particles[a].x - particles[b].x;
                    let dy = particles[a].y - particles[b].y;
                    let distance = Math.sqrt(dx * dx + dy * dy);
                    if (distance < 150) {
                      ctx.strokeStyle = 'rgba(14, 165, 233, ' + ((1 - distance / 150) * 0.15) + ')';
                      ctx.lineWidth = 1;
                      ctx.beginPath();
                      ctx.moveTo(particles[a].x, particles[a].y);
                      ctx.lineTo(particles[b].x, particles[b].y);
                      ctx.stroke();
                    }
                  }
                }
              }

              function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                particles.forEach(p => { p.update(); p.draw(); });
                connectParticles();
                requestAnimationFrame(animate);
              }
              animate();

              // Search functionality
              let searchMode = 'title';
              let searchIndex = null;
              let flattenedIndex = null;
              let fuse = null;

              const search = document.getElementById('search');
              const categories = document.querySelectorAll('.category');
              const noResults = document.getElementById('no-results');
              const contentResults = document.getElementById('content-results');
              const searchLoading = document.getElementById('search-loading');

              // Load search index for content search
              async function loadSearchIndex() {
                try {
                  const response = await fetch('search-index.json');
                  searchIndex = await response.json();
                  // Flatten the index: one entry per page for searching
                  flattenedIndex = [];
                  searchIndex.forEach(doc => {
                    doc.pages.forEach(pageData => {
                      flattenedIndex.push({
                        id: doc.id,
                        num: doc.num,
                        title: doc.title,
                        category: doc.category,
                        totalPages: doc.totalPages,
                        page: pageData.page,
                        text: pageData.text
                      });
                    });
                  });
                  // Initialize Fuse.js for fuzzy search on flattened index
                  fuse = new Fuse(flattenedIndex, {
                    keys: ['title', 'text'],
                    threshold: 0.3,
                    includeMatches: true,
                    minMatchCharLength: 3,
                    ignoreLocation: true
                  });
                  console.log('Search index loaded:', searchIndex.length, 'documents,', flattenedIndex.length, 'pages');
                } catch (e) {
                  console.error('Failed to load search index:', e);
                }
              }

              // Set search mode
              function setSearchMode(mode) {
                searchMode = mode;
                document.getElementById('mode-title').classList.toggle('active', mode === 'title');
                document.getElementById('mode-content').classList.toggle('active', mode === 'content');
                // Re-run search with current query
                performSearch(search.value);
              }

              // Extract snippet around match
              function getSnippet(text, query, maxLen = 200) {
                const lowerText = text.toLowerCase();
                const lowerQuery = query.toLowerCase();
                const idx = lowerText.indexOf(lowerQuery);
                if (idx === -1) return text.slice(0, maxLen) + '...';
                const start = Math.max(0, idx - 60);
                const end = Math.min(text.length, idx + query.length + 140);
                let snippet = (start > 0 ? '...' : '') + text.slice(start, end) + (end < text.length ? '...' : '');
                // Highlight matches
                const regex = new RegExp('(' + query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi');
                snippet = snippet.replace(regex, '<mark>$1</mark>');
                return snippet;
              }

              // Perform search based on mode
              function performSearch(query) {
                query = query.trim();
                if (searchMode === 'title') {
                  // Title search - show categories
                  contentResults.classList.remove('visible');
                  document.getElementById('categories').style.display = '';
                  const lowerQuery = query.toLowerCase();
                  let hasResults = false;
                  categories.forEach(cat => {
                    const items = cat.querySelectorAll('.doc-item');
                    let match = false;
                    items.forEach(item => {
                      const title = item.dataset.title.toLowerCase();
                      const num = item.querySelector('.doc-num').textContent;
                      const m = title.includes(lowerQuery) || num.includes(lowerQuery);
                      item.classList.toggle('hidden', !m && query !== '');
                      if (m || query === '') match = true;
                    });
                    cat.classList.toggle('hidden', !match);
                    if (match) hasResults = true;
                  });
                  noResults.classList.toggle('hidden', hasResults || query === '');
                } else {
                  // Content search - show results list
                  document.getElementById('categories').style.display = 'none';
                  if (!query || query.length < 2) {
                    contentResults.classList.remove('visible');
                    document.getElementById('categories').style.display = '';
                    noResults.classList.add('hidden');
                    return;
                  }
                  if (!fuse) {
                    searchLoading.classList.add('visible');
                    loadSearchIndex().then(() => {
                      searchLoading.classList.remove('visible');
                      performSearch(query);
                    });
                    return;
                  }
                  const results = fuse.search(query, { limit: 30 });
                  contentResults.innerHTML = '';
                  if (results.length === 0) {
                    contentResults.classList.remove('visible');
                    noResults.classList.remove('hidden');
                    return;
                  }
                  noResults.classList.add('hidden');
                  contentResults.classList.add('visible');
                  // Group by document to avoid too many results from same doc
                  const seen = new Map();
                  results.forEach(result => {
                    const doc = result.item;
                    const key = doc.id;
                    if (!seen.has(key)) {
                      seen.set(key, []);
                    }
                    if (seen.get(key).length < 3) { // Max 3 pages per document
                      seen.get(key).push(doc);
                    }
                  });
                  seen.forEach((pages, docId) => {
                    pages.forEach(doc => {
                      const snippet = getSnippet(doc.text, query);
                      const item = document.createElement('div');
                      item.className = 'content-result-item';
                      item.onclick = () => window.location.href = 'viewer.html?file=' + doc.id + '.pdf&page=' + doc.page;
                      item.innerHTML = '<div class="content-result-header">' +
                        '<span class="content-result-num">' + doc.num + '</span>' +
                        '<span class="content-result-title">' + doc.title + '</span>' +
                        '<span class="content-result-page">Page ' + doc.page + '/' + doc.totalPages + '</span>' +
                        '<span class="content-result-category">' + doc.category + '</span>' +
                        '</div>' +
                        '<div class="content-result-snippet">' + snippet + '</div>';
                      contentResults.appendChild(item);
                    });
                  });
                }
              }

              // Debounce search input
              let searchTimeout;
              search.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => performSearch(e.target.value), 150);
              });

              // Preload search index
              loadSearchIndex();
            </script>
          </body>
          </html>
          HTMLEOF

          sed -i "s/TIMESTAMP/$(date -u +'%Y-%m-%d %H:%M UTC')/g" public/index.html
          sed -i "s/PDF_COUNT/$PDF_COUNT/g" public/index.html

      - name: Setup Pages
        uses: actions/configure-pages@v4
        with:
          enablement: true

      - name: Upload to Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: public/

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
